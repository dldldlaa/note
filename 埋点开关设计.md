# 埋点的开关应该怎么设计？

## 设计目标
- **安全默认值**：配置拉取失败或超时时，行为可预期，不影响核心链路。
- **可灰度/热更新**：无需发版即可调整开关和采样率。
- **可观测性**：切换生效情况和埋点缺失要有监控与告警。

## 开关分层
1. **全局主开关**：一键关闭所有埋点，兜底风险（崩溃、性能异常等）。
2. **业务/场景开关**：按页面、功能或渠道维度控制，便于灰度和定向关闭。
3. **事件级开关**：精准关闭单个关键事件或高风险事件。
4. **采样开关**：通过采样率控制流量，减少高并发或异常场景压力。
5. **调试模式**：仅在指定用户/设备开启，输出本地日志用于验证。

## 配置来源与生效策略
- **远程配置中心/AB 平台**：拉取实时配置，支持灰度、白名单和回滚。
- **本地内置默认值**：远程获取失败时使用，确保可用性（生产环境默认“开”，若存在隐私或性能高风险场景可默认“关”并在灰度验证后开启）。
- **缓存与时效**：配置包含版本号和 TTL，按周期刷新，失败时沿用上次成功结果。
- **优先级**：调试模式 > 事件级 > 业务级 > 全局主开关（全局“关”时直接短路）。

## 监控与告警
- 记录配置版本、生效时间和切换人，支持审计。
- 监控埋点发送成功率、延迟、异常量；全局或关键事件关闭时触发告警。
- 在客户端/服务端埋点 SDK 内部输出关键状态日志，便于问题定位。

## 实施要点
- SDK 层提供统一的开关判断接口，避免业务侧重复逻辑。
- 切换应即时生效（监听配置更新事件），并在关键路径做好超时与降级。
- 对隐私数据遵循合规要求，开关关闭后应停止采集并清理缓存。
